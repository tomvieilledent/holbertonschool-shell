#!/usr/bin/env bash
set -euo pipefail

# Fonction pour obtenir la taille du fichier selon OS
if [[ "$(uname)" == "Darwin" ]]; then
    stat_size() { stat -f "%z" "$1"; }
else
    stat_size() { stat -c "%s" "$1"; }
fi

# Fonction pour dÃ©tecter le type de fichier et retourner une icÃ´ne
file_icon() {
    local file="$1"
    if [[ -d "$file" ]]; then
        echo "ğŸ“"
    else
        ext="${file##*.}"
        case "$ext" in
            md|txt|rst) echo "ğŸ“„" ;;
            sh|py|js|rb|pl) echo "âš™ï¸" ;;
            jpg|jpeg|png|gif|svg) echo "ğŸ–¼ï¸" ;;
            pdf) echo "ğŸ“•" ;;
            *) echo "ğŸ“„" ;; # fichier gÃ©nÃ©rique
        esac
    fi
}

# Fonction pour gÃ©nÃ©rer un tableau Markdown
generate_table() {
    local items=("$@")
    printf "| %-2s | %-30s | %-10s | %-10s |\n" "Icon" "Name" "Type" "Size"
    printf "|-%-2s-|-%-30s-|-%-10s-|-%-10s-|\n" "$(printf '%.0s-' {1..2})" "$(printf '%.0s-' {1..30})" "$(printf '%.0s-' {1..10})" "$(printf '%.0s-' {1..10})"
    for f in "${items[@]}"; do
        IFS='|' read -r icon name type size <<< "$f"

        # Pour les dossiers, pointer vers README.md
        if [[ "$type" == "Directory" ]]; then
            link="$name/README.md"
        else
            link="$name"
        fi

        printf "| %s | [%s](%s) | %s | %s |\n" "$icon" "$name" "$link" "$type" "$size"
    done
}

# Fonction principale pour gÃ©nÃ©rer README dans un dossier
generate_readme() {
    local DIR="$1"
    local OUTPUT_FILE="$DIR/README.md"
    [[ -f "$OUTPUT_FILE" ]] && rm "$OUTPUT_FILE"

    local PROJECT_NAME=$(basename "$DIR")

    # --- Fichiers visibles uniquement ---
    local files=()
    while IFS= read -r file; do
        name=$(basename "$file")
        icon=$(file_icon "$file")
        size="$(stat_size "$file") bytes"
        files+=("$icon|$name|File|$size")
    done < <(find "$DIR" -maxdepth 1 -type f ! -iname "readme.md" ! -name ".*" | sort -V)

    # --- Sous-dossiers visibles uniquement ---
    local subdirs=()
    while IFS= read -r dir; do
        name=$(basename "$dir")
        icon=$(file_icon "$dir")
        subdirs+=("$icon|$name|Directory|-")
    done < <(find "$DIR" -maxdepth 1 -type d ! -path "$DIR" ! -name ".*" | sort -V)

    # --- Ã‰criture README.md ---
    {
        echo "# $PROJECT_NAME"
        echo
        if [[ ${#files[@]} -gt 0 ]]; then
            echo "## Files"
            echo
            generate_table "${files[@]}"
        fi
        if [[ ${#subdirs[@]} -gt 0 ]]; then
            echo
            echo "## Subdirectories"
            echo
            generate_table "${subdirs[@]}"
        fi
    } > "$OUTPUT_FILE"

    echo "âœ… README.md generated in '$DIR'"

    # --- RÃ©cursion dans les sous-dossiers visibles ---
    for dir in "${subdirs[@]}"; do
        IFS='|' read -r _ sub_name _ _ <<< "$dir"
        generate_readme "$DIR/$sub_name"
    done
}

# Lancer la gÃ©nÃ©ration depuis le dossier courant
generate_readme "$(pwd)"
